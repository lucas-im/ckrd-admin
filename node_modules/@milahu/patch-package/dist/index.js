"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const chalk_1 = __importDefault(require("chalk"));
const process_1 = __importDefault(require("process"));
const dashdash_1 = __importDefault(require("dashdash"));
const getAppRootPath_1 = require("./getAppRootPath");
const path_1 = require("./path");
const appPath = (0, getAppRootPath_1.getAppRootPath)();
var dashdashOptions = [
    { name: "use-yarn", type: "bool" },
    { name: "create-issue", type: "bool" },
    { name: "case-sensitive-path-filtering", type: "bool" },
    { name: "reverse", type: "bool" },
    { names: ["help", "h"], type: "bool" },
    { names: ["version", "v"], type: "bool" },
    { name: "error-on-fail", type: "bool" },
    { name: "verbose", type: "bool" },
    { name: "debug", type: "bool" },
    { name: "patch-dir", type: "string" },
    { name: "include", type: "string" },
    { name: "exclude", type: "string" },
];
const argv = dashdash_1.default.parse({ options: dashdashOptions });
const packageNames = argv._args;
// globals are used in imported modules
const isDebug = argv.debug;
//const isDebug = true
global.patchPackageIsDebug = isDebug;
global.patchPackageIsVerbose = isDebug || argv.verbose;
const isTest = process_1.default.env.TEST_PATCH_PACKAGE == 'true';
global.patchPackageIsTest = isTest;
const patchPackageVersion = isTest ? '0.0.0' : require((0, path_1.join)(__dirname, "../package.json")).version;
global.patchPackageVersion = patchPackageVersion;
console.log(chalk_1.default.bold("patch-package"), 
// tslint:disable-next-line:no-var-requires
patchPackageVersion);
if (isDebug) {
    console.log(`patch-package/index: argv:`);
    console.dir(argv);
}
const applyPatches_1 = require("./applyPatches");
const makePatch_1 = require("./makePatch");
const makeRegExp_1 = require("./makeRegExp");
const detectPackageManager_1 = require("./detectPackageManager");
const path_2 = require("path");
const slash_1 = __importDefault(require("slash"));
const isCi = process_1.default.env.CI == "true";
if (argv.version) {
    // noop
}
else if (argv.help) {
    printHelp();
}
else {
    const patchDir = (0, slash_1.default)((0, path_2.normalize)((argv.patch_dir || "patches") + path_2.sep));
    if (patchDir.startsWith("/")) {
        throw new Error("--patch-dir must be a relative path");
    }
    if (packageNames.length) {
        const includePaths = (0, makeRegExp_1.makeRegExp)(argv.include, "include", /.*/, argv.case_sensitive_path_filtering);
        const excludePaths = (0, makeRegExp_1.makeRegExp)(argv.exclude, "exclude", 
        // exclude the top-level package.json file
        /^package\.json$/, argv.case_sensitive_path_filtering);
        const packageManager = (0, detectPackageManager_1.detectPackageManager)(appPath, argv.use_yarn ? "yarn" : null);
        if (isDebug) {
            console.log(`patch-package/index: packageManager = ${packageManager}`);
        }
        const createIssue = argv.create_issue;
        packageNames.forEach((packagePathSpecifier) => {
            (0, makePatch_1.makePatch)({
                packagePathSpecifier,
                appPath,
                packageManager,
                includePaths,
                excludePaths,
                patchDir,
                createIssue,
            });
        });
    }
    else {
        console.log("Applying patches...");
        const reverse = argv.reverse;
        // don't want to exit(1) on postinsall locally.
        // see https://github.com/ds300/patch-package/issues/86
        // debug
        if (isDebug) {
            console.dir({
                error_on_fail: argv.error_on_fail,
                isCi,
                NODE_ENV: process_1.default.env.NODE_ENV,
            });
        }
        const shouldExitWithError = argv.error_on_fail || isCi || process_1.default.env.NODE_ENV === "test";
        (0, applyPatches_1.applyPatchesForApp)({ appPath, reverse, patchDir, shouldExitWithError });
    }
}
function printHelp() {
    console.log(`
Usage:

  1. Patching packages
  ====================

    ${chalk_1.default.bold("patch-package")}

  Without arguments, the ${chalk_1.default.bold("patch-package")} command will attempt to find and apply
  patch files to your project. It looks for files named like

     ./patches/<package-name>+<version>.patch

  Options:

    ${chalk_1.default.bold("--patch-dir <dirname>")}

      Specify the name for the directory in which the patch files are located.
      
    ${chalk_1.default.bold("--error-on-fail")}
    
      Forces patch-package to exit with code 1 after failing.
    
      When running locally patch-package always exits with 0 by default.
      This happens even after failing to apply patches because otherwise 
      yarn.lock and package.json might get out of sync with node_modules,
      which can be very confusing.
      
      --error-on-fail is ${chalk_1.default.bold("switched on")} by default on CI.
      
      See https://github.com/ds300/patch-package/issues/86 for background.

    ${chalk_1.default.bold("--reverse")}
        
      Un-applies all patches.

      Note that this will fail if the patched files have changed since being
      patched. In that case, you'll probably need to re-install 'node_modules'.

      This option was added to help people using CircleCI avoid an issue around caching
      and patch file updates (https://github.com/ds300/patch-package/issues/37),
      but might be useful in other contexts too.
      

  2. Creating patch files
  =======================

    ${chalk_1.default.bold("patch-package")} <package-name>${chalk_1.default.italic("[ <package-name>]")}

  When given package names as arguments, patch-package will create patch files
  based on any changes you've made to the versions installed by yarn/npm.

  Options:
  
    ${chalk_1.default.bold("--create-issue")}
    
       For packages whose source is hosted on GitHub this option opens a web
       browser with a draft issue based on your diff.

    ${chalk_1.default.bold("--use-yarn")}

        By default, patch-package checks whether you use npm or yarn based on
        which lockfile you have. If you have both, it uses npm by default.
        Set this option to override that default and always use yarn.

    ${chalk_1.default.bold("--exclude <regexp>")}

        Ignore paths matching the regexp when creating patch files.
        Paths are relative to the root dir of the package to be patched.

        Default: 'package\\.json$'

    ${chalk_1.default.bold("--include <regexp>")}

        Only consider paths matching the regexp when creating patch files.
        Paths are relative to the root dir of the package to be patched.

        Default '.*'

    ${chalk_1.default.bold("--case-sensitive-path-filtering")}

        Make regexps used in --include or --exclude filters case-sensitive.
    
    ${chalk_1.default.bold("--patch-dir")}

        Specify the name for the directory in which to put the patch files.
`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxrREFBeUI7QUFDekIsc0RBQTZCO0FBQzdCLHdEQUErQjtBQUUvQixxREFBaUQ7QUFDakQsaUNBQTZCO0FBRTdCLE1BQU0sT0FBTyxHQUFHLElBQUEsK0JBQWMsR0FBRSxDQUFBO0FBRWhDLElBQUksZUFBZSxHQUFHO0lBQ3BCLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQ2xDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQ3RDLEVBQUUsSUFBSSxFQUFFLCtCQUErQixFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7SUFDdkQsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7SUFDakMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtJQUN0QyxFQUFFLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQ3pDLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQ3ZDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQ2pDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO0lBQy9CLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO0lBQ3JDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO0lBQ25DLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFO0NBQ3BDLENBQUM7QUFF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QU0sQ0FDM0QsbUJBQW1CLENBQ3BCOzs7Ozs7O01BT0csZUFBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQzs7Ozs7TUFLNUIsZUFBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7Ozs7OztNQU14QixlQUFLLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDOzs7Ozs7O01BT2hDLGVBQUssQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUM7Ozs7Ozs7TUFPaEMsZUFBSyxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQzs7OztNQUk3QyxlQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQzs7O0NBRzlCLENBQUMsQ0FBQTtBQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSBcImNoYWxrXCJcbmltcG9ydCBwcm9jZXNzIGZyb20gXCJwcm9jZXNzXCJcbmltcG9ydCBkYXNoZGFzaCBmcm9tIFwiZGFzaGRhc2hcIlxuXG5pbXBvcnQgeyBnZXRBcHBSb290UGF0aCB9IGZyb20gXCIuL2dldEFwcFJvb3RQYXRoXCJcbmltcG9ydCB7IGpvaW4gfSBmcm9tIFwiLi9wYXRoXCJcblxuY29uc3QgYXBwUGF0aCA9IGdldEFwcFJvb3RQYXRoKClcblxudmFyIGRhc2hkYXNoT3B0aW9ucyA9IFtcbiAgeyBuYW1lOiBcInVzZS15YXJuXCIsIHR5cGU6IFwiYm9vbFwiIH0sXG4gIHsgbmFtZTogXCJjcmVhdGUtaXNzdWVcIiwgdHlwZTogXCJib29sXCIgfSxcbiAgeyBuYW1lOiBcImNhc2Utc2Vuc2l0aXZlLXBhdGgtZmlsdGVyaW5nXCIsIHR5cGU6IFwiYm9vbFwiIH0sXG4gIHsgbmFtZTogXCJyZXZlcnNlXCIsIHR5cGU6IFwiYm9vbFwiIH0sXG4gIHsgbmFtZXM6IFtcImhlbHBcIiwgXCJoXCJdLCB0eXBlOiBcImJvb2xcIiB9LFxuICB7IG5hbWVzOiBbXCJ2ZXJzaW9uXCIsIFwidlwiXSwgdHlwZTogXCJib29sXCIgfSxcbiAgeyBuYW1lOiBcImVycm9yLW9uLWZhaWxcIiwgdHlwZTogXCJib29sXCIgfSxcbiAgeyBuYW1lOiBcInZlcmJvc2VcIiwgdHlwZTogXCJib29sXCIgfSxcbiAgeyBuYW1lOiBcImRlYnVnXCIsIHR5cGU6IFwiYm9vbFwiIH0sXG4gIHsgbmFtZTogXCJwYXRjaC1kaXJcIiwgdHlwZTogXCJzdHJpbmdcIiB9LFxuICB7IG5hbWU6IFwiaW5jbHVkZVwiLCB0eXBlOiBcInN0cmluZ1wiIH0sXG4gIHsgbmFtZTogXCJleGNsdWRlXCIsIHR5cGU6IFwic3RyaW5nXCIgfSxcbl07XG5cbmNvbnN0IGFyZ3YgPSBkYXNoZGFzaC5wYXJzZSh7IG9wdGlvbnM6IGRhc2hkYXNoT3B0aW9ucyB9KTtcblxuY29uc3QgcGFja2FnZU5hbWVzID0gYXJndi5fYXJnc1xuXG4vLyBnbG9iYWxzIGFyZSB1c2VkIGluIGltcG9ydGVkIG1vZHVsZXNcbmNvbnN0IGlzRGVidWcgPSBhcmd2LmRlYnVnXG4vL2NvbnN0IGlzRGVidWcgPSB0cnVlXG5nbG9iYWwucGF0Y2hQYWNrYWdlSXNEZWJ1ZyA9IGlzRGVidWdcblxuZ2xvYmFsLnBhdGNoUGFja2FnZUlzVmVyYm9zZSA9IGlzRGVidWcgfHwgYXJndi52ZXJib3NlXG5cbmNvbnN0IGlzVGVzdCA9IHByb2Nlc3MuZW52LlRFU1RfUEFUQ0hfUEFDS0FHRSA9PSAndHJ1ZSdcbmdsb2JhbC5wYXRjaFBhY2thZ2VJc1Rlc3QgPSBpc1Rlc3RcblxuY29uc3QgcGF0Y2hQYWNrYWdlVmVyc2lvbiA9IGlzVGVzdCA/ICcwLjAuMCcgOiByZXF1aXJlKGpvaW4oX19kaXJuYW1lLCBcIi4uL3BhY2thZ2UuanNvblwiKSkudmVyc2lvblxuZ2xvYmFsLnBhdGNoUGFja2FnZVZlcnNpb24gPSBwYXRjaFBhY2thZ2VWZXJzaW9uXG5cbmNvbnNvbGUubG9nKFxuICBjaGFsay5ib2xkKFwicGF0Y2gtcGFja2FnZVwiKSxcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXZhci1yZXF1aXJlc1xuICBwYXRjaFBhY2thZ2VWZXJzaW9uLFxuKVxuXG5pZiAoaXNEZWJ1Zykge1xuICBjb25zb2xlLmxvZyhgcGF0Y2gtcGFja2FnZS9pbmRleDogYXJndjpgKVxuICBjb25zb2xlLmRpcihhcmd2KVxufVxuXG5pbXBvcnQgeyBhcHBseVBhdGNoZXNGb3JBcHAgfSBmcm9tIFwiLi9hcHBseVBhdGNoZXNcIlxuaW1wb3J0IHsgbWFrZVBhdGNoIH0gZnJvbSBcIi4vbWFrZVBhdGNoXCJcbmltcG9ydCB7IG1ha2VSZWdFeHAgfSBmcm9tIFwiLi9tYWtlUmVnRXhwXCJcbmltcG9ydCB7IGRldGVjdFBhY2thZ2VNYW5hZ2VyIH0gZnJvbSBcIi4vZGV0ZWN0UGFja2FnZU1hbmFnZXJcIlxuaW1wb3J0IHsgbm9ybWFsaXplLCBzZXAgfSBmcm9tIFwicGF0aFwiXG5pbXBvcnQgc2xhc2ggZnJvbSBcInNsYXNoXCJcblxuY29uc3QgaXNDaSA9IHByb2Nlc3MuZW52LkNJID09IFwidHJ1ZVwiXG5cbmlmIChhcmd2LnZlcnNpb24pIHtcbiAgLy8gbm9vcFxufSBlbHNlIGlmIChhcmd2LmhlbHApIHtcbiAgcHJpbnRIZWxwKClcbn0gZWxzZSB7XG4gIGNvbnN0IHBhdGNoRGlyID0gc2xhc2gobm9ybWFsaXplKChhcmd2LnBhdGNoX2RpciB8fCBcInBhdGNoZXNcIikgKyBzZXApKVxuICBpZiAocGF0Y2hEaXIuc3RhcnRzV2l0aChcIi9cIikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCItLXBhdGNoLWRpciBtdXN0IGJlIGEgcmVsYXRpdmUgcGF0aFwiKVxuICB9XG4gIGlmIChwYWNrYWdlTmFtZXMubGVuZ3RoKSB7XG4gICAgY29uc3QgaW5jbHVkZVBhdGhzID0gbWFrZVJlZ0V4cChcbiAgICAgIGFyZ3YuaW5jbHVkZSxcbiAgICAgIFwiaW5jbHVkZVwiLFxuICAgICAgLy4qLyxcbiAgICAgIGFyZ3YuY2FzZV9zZW5zaXRpdmVfcGF0aF9maWx0ZXJpbmcsXG4gICAgKVxuICAgIGNvbnN0IGV4Y2x1ZGVQYXRocyA9IG1ha2VSZWdFeHAoXG4gICAgICBhcmd2LmV4Y2x1ZGUsXG4gICAgICBcImV4Y2x1ZGVcIixcbiAgICAgIC8vIGV4Y2x1ZGUgdGhlIHRvcC1sZXZlbCBwYWNrYWdlLmpzb24gZmlsZVxuICAgICAgL15wYWNrYWdlXFwuanNvbiQvLFxuICAgICAgYXJndi5jYXNlX3NlbnNpdGl2ZV9wYXRoX2ZpbHRlcmluZyxcbiAgICApXG4gICAgY29uc3QgcGFja2FnZU1hbmFnZXIgPSBkZXRlY3RQYWNrYWdlTWFuYWdlcihcbiAgICAgIGFwcFBhdGgsXG4gICAgICBhcmd2LnVzZV95YXJuID8gXCJ5YXJuXCIgOiBudWxsLFxuICAgIClcbiAgICBpZiAoaXNEZWJ1Zykge1xuICAgICAgY29uc29sZS5sb2coYHBhdGNoLXBhY2thZ2UvaW5kZXg6IHBhY2thZ2VNYW5hZ2VyID0gJHtwYWNrYWdlTWFuYWdlcn1gKVxuICAgIH1cblxuICAgIGNvbnN0IGNyZWF0ZUlzc3VlID0gYXJndi5jcmVhdGVfaXNzdWVcbiAgICBwYWNrYWdlTmFtZXMuZm9yRWFjaCgocGFja2FnZVBhdGhTcGVjaWZpZXI6IHN0cmluZykgPT4ge1xuICAgICAgbWFrZVBhdGNoKHtcbiAgICAgICAgcGFja2FnZVBhdGhTcGVjaWZpZXIsXG4gICAgICAgIGFwcFBhdGgsXG4gICAgICAgIHBhY2thZ2VNYW5hZ2VyLFxuICAgICAgICBpbmNsdWRlUGF0aHMsXG4gICAgICAgIGV4Y2x1ZGVQYXRocyxcbiAgICAgICAgcGF0Y2hEaXIsXG4gICAgICAgIGNyZWF0ZUlzc3VlLFxuICAgICAgfSlcbiAgICB9KVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKFwiQXBwbHlpbmcgcGF0Y2hlcy4uLlwiKVxuICAgIGNvbnN0IHJldmVyc2UgPSBhcmd2LnJldmVyc2VcbiAgICAvLyBkb24ndCB3YW50IHRvIGV4aXQoMSkgb24gcG9zdGluc2FsbCBsb2NhbGx5LlxuICAgIC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vZHMzMDAvcGF0Y2gtcGFja2FnZS9pc3N1ZXMvODZcbiAgICAvLyBkZWJ1Z1xuICAgIGlmIChpc0RlYnVnKSB7XG4gICAgICBjb25zb2xlLmRpcih7XG4gICAgICAgIGVycm9yX29uX2ZhaWw6IGFyZ3YuZXJyb3Jfb25fZmFpbCxcbiAgICAgICAgaXNDaSxcbiAgICAgICAgTk9ERV9FTlY6IHByb2Nlc3MuZW52Lk5PREVfRU5WLFxuICAgICAgfSlcbiAgICB9XG4gICAgY29uc3Qgc2hvdWxkRXhpdFdpdGhFcnJvciA9XG4gICAgICBhcmd2LmVycm9yX29uX2ZhaWwgfHwgaXNDaSB8fCBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJ0ZXN0XCJcbiAgICBhcHBseVBhdGNoZXNGb3JBcHAoeyBhcHBQYXRoLCByZXZlcnNlLCBwYXRjaERpciwgc2hvdWxkRXhpdFdpdGhFcnJvciB9KVxuICB9XG59XG5cbmZ1bmN0aW9uIHByaW50SGVscCgpIHtcbiAgY29uc29sZS5sb2coYFxuVXNhZ2U6XG5cbiAgMS4gUGF0Y2hpbmcgcGFja2FnZXNcbiAgPT09PT09PT09PT09PT09PT09PT1cblxuICAgICR7Y2hhbGsuYm9sZChcInBhdGNoLXBhY2thZ2VcIil9XG5cbiAgV2l0aG91dCBhcmd1bWVudHMsIHRoZSAke2NoYWxrLmJvbGQoXG4gICAgXCJwYXRjaC1wYWNrYWdlXCIsXG4gICl9IGNvbW1hbmQgd2lsbCBhdHRlbXB0IHRvIGZpbmQgYW5kIGFwcGx5XG4gIHBhdGNoIGZpbGVzIHRvIHlvdXIgcHJvamVjdC4gSXQgbG9va3MgZm9yIGZpbGVzIG5hbWVkIGxpa2VcblxuICAgICAuL3BhdGNoZXMvPHBhY2thZ2UtbmFtZT4rPHZlcnNpb24+LnBhdGNoXG5cbiAgT3B0aW9uczpcblxuICAgICR7Y2hhbGsuYm9sZChcIi0tcGF0Y2gtZGlyIDxkaXJuYW1lPlwiKX1cblxuICAgICAgU3BlY2lmeSB0aGUgbmFtZSBmb3IgdGhlIGRpcmVjdG9yeSBpbiB3aGljaCB0aGUgcGF0Y2ggZmlsZXMgYXJlIGxvY2F0ZWQuXG4gICAgICBcbiAgICAke2NoYWxrLmJvbGQoXCItLWVycm9yLW9uLWZhaWxcIil9XG4gICAgXG4gICAgICBGb3JjZXMgcGF0Y2gtcGFja2FnZSB0byBleGl0IHdpdGggY29kZSAxIGFmdGVyIGZhaWxpbmcuXG4gICAgXG4gICAgICBXaGVuIHJ1bm5pbmcgbG9jYWxseSBwYXRjaC1wYWNrYWdlIGFsd2F5cyBleGl0cyB3aXRoIDAgYnkgZGVmYXVsdC5cbiAgICAgIFRoaXMgaGFwcGVucyBldmVuIGFmdGVyIGZhaWxpbmcgdG8gYXBwbHkgcGF0Y2hlcyBiZWNhdXNlIG90aGVyd2lzZSBcbiAgICAgIHlhcm4ubG9jayBhbmQgcGFja2FnZS5qc29uIG1pZ2h0IGdldCBvdXQgb2Ygc3luYyB3aXRoIG5vZGVfbW9kdWxlcyxcbiAgICAgIHdoaWNoIGNhbiBiZSB2ZXJ5IGNvbmZ1c2luZy5cbiAgICAgIFxuICAgICAgLS1lcnJvci1vbi1mYWlsIGlzICR7Y2hhbGsuYm9sZChcInN3aXRjaGVkIG9uXCIpfSBieSBkZWZhdWx0IG9uIENJLlxuICAgICAgXG4gICAgICBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2RzMzAwL3BhdGNoLXBhY2thZ2UvaXNzdWVzLzg2IGZvciBiYWNrZ3JvdW5kLlxuXG4gICAgJHtjaGFsay5ib2xkKFwiLS1yZXZlcnNlXCIpfVxuICAgICAgICBcbiAgICAgIFVuLWFwcGxpZXMgYWxsIHBhdGNoZXMuXG5cbiAgICAgIE5vdGUgdGhhdCB0aGlzIHdpbGwgZmFpbCBpZiB0aGUgcGF0Y2hlZCBmaWxlcyBoYXZlIGNoYW5nZWQgc2luY2UgYmVpbmdcbiAgICAgIHBhdGNoZWQuIEluIHRoYXQgY2FzZSwgeW91J2xsIHByb2JhYmx5IG5lZWQgdG8gcmUtaW5zdGFsbCAnbm9kZV9tb2R1bGVzJy5cblxuICAgICAgVGhpcyBvcHRpb24gd2FzIGFkZGVkIHRvIGhlbHAgcGVvcGxlIHVzaW5nIENpcmNsZUNJIGF2b2lkIGFuIGlzc3VlIGFyb3VuZCBjYWNoaW5nXG4gICAgICBhbmQgcGF0Y2ggZmlsZSB1cGRhdGVzIChodHRwczovL2dpdGh1Yi5jb20vZHMzMDAvcGF0Y2gtcGFja2FnZS9pc3N1ZXMvMzcpLFxuICAgICAgYnV0IG1pZ2h0IGJlIHVzZWZ1bCBpbiBvdGhlciBjb250ZXh0cyB0b28uXG4gICAgICBcblxuICAyLiBDcmVhdGluZyBwYXRjaCBmaWxlc1xuICA9PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgJHtjaGFsay5ib2xkKFwicGF0Y2gtcGFja2FnZVwiKX0gPHBhY2thZ2UtbmFtZT4ke2NoYWxrLml0YWxpYyhcbiAgICBcIlsgPHBhY2thZ2UtbmFtZT5dXCIsXG4gICl9XG5cbiAgV2hlbiBnaXZlbiBwYWNrYWdlIG5hbWVzIGFzIGFyZ3VtZW50cywgcGF0Y2gtcGFja2FnZSB3aWxsIGNyZWF0ZSBwYXRjaCBmaWxlc1xuICBiYXNlZCBvbiBhbnkgY2hhbmdlcyB5b3UndmUgbWFkZSB0byB0aGUgdmVyc2lvbnMgaW5zdGFsbGVkIGJ5IHlhcm4vbnBtLlxuXG4gIE9wdGlvbnM6XG4gIFxuICAgICR7Y2hhbGsuYm9sZChcIi0tY3JlYXRlLWlzc3VlXCIpfVxuICAgIFxuICAgICAgIEZvciBwYWNrYWdlcyB3aG9zZSBzb3VyY2UgaXMgaG9zdGVkIG9uIEdpdEh1YiB0aGlzIG9wdGlvbiBvcGVucyBhIHdlYlxuICAgICAgIGJyb3dzZXIgd2l0aCBhIGRyYWZ0IGlzc3VlIGJhc2VkIG9uIHlvdXIgZGlmZi5cblxuICAgICR7Y2hhbGsuYm9sZChcIi0tdXNlLXlhcm5cIil9XG5cbiAgICAgICAgQnkgZGVmYXVsdCwgcGF0Y2gtcGFja2FnZSBjaGVja3Mgd2hldGhlciB5b3UgdXNlIG5wbSBvciB5YXJuIGJhc2VkIG9uXG4gICAgICAgIHdoaWNoIGxvY2tmaWxlIHlvdSBoYXZlLiBJZiB5b3UgaGF2ZSBib3RoLCBpdCB1c2VzIG5wbSBieSBkZWZhdWx0LlxuICAgICAgICBTZXQgdGhpcyBvcHRpb24gdG8gb3ZlcnJpZGUgdGhhdCBkZWZhdWx0IGFuZCBhbHdheXMgdXNlIHlhcm4uXG5cbiAgICAke2NoYWxrLmJvbGQoXCItLWV4Y2x1ZGUgPHJlZ2V4cD5cIil9XG5cbiAgICAgICAgSWdub3JlIHBhdGhzIG1hdGNoaW5nIHRoZSByZWdleHAgd2hlbiBjcmVhdGluZyBwYXRjaCBmaWxlcy5cbiAgICAgICAgUGF0aHMgYXJlIHJlbGF0aXZlIHRvIHRoZSByb290IGRpciBvZiB0aGUgcGFja2FnZSB0byBiZSBwYXRjaGVkLlxuXG4gICAgICAgIERlZmF1bHQ6ICdwYWNrYWdlXFxcXC5qc29uJCdcblxuICAgICR7Y2hhbGsuYm9sZChcIi0taW5jbHVkZSA8cmVnZXhwPlwiKX1cblxuICAgICAgICBPbmx5IGNvbnNpZGVyIHBhdGhzIG1hdGNoaW5nIHRoZSByZWdleHAgd2hlbiBjcmVhdGluZyBwYXRjaCBmaWxlcy5cbiAgICAgICAgUGF0aHMgYXJlIHJlbGF0aXZlIHRvIHRoZSByb290IGRpciBvZiB0aGUgcGFja2FnZSB0byBiZSBwYXRjaGVkLlxuXG4gICAgICAgIERlZmF1bHQgJy4qJ1xuXG4gICAgJHtjaGFsay5ib2xkKFwiLS1jYXNlLXNlbnNpdGl2ZS1wYXRoLWZpbHRlcmluZ1wiKX1cblxuICAgICAgICBNYWtlIHJlZ2V4cHMgdXNlZCBpbiAtLWluY2x1ZGUgb3IgLS1leGNsdWRlIGZpbHRlcnMgY2FzZS1zZW5zaXRpdmUuXG4gICAgXG4gICAgJHtjaGFsay5ib2xkKFwiLS1wYXRjaC1kaXJcIil9XG5cbiAgICAgICAgU3BlY2lmeSB0aGUgbmFtZSBmb3IgdGhlIGRpcmVjdG9yeSBpbiB3aGljaCB0byBwdXQgdGhlIHBhdGNoIGZpbGVzLlxuYClcbn1cbiJdfQ==