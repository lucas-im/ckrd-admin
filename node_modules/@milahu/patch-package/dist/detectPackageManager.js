"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.detectPackageManager = void 0;
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = require("./path");
//import path from "path"
const chalk_1 = __importDefault(require("chalk"));
const process_1 = __importDefault(require("process"));
//const isVerbose = global.patchPackageIsVerbose
const isDebug = global.patchPackageIsDebug;
/*
function printNoYarnLockfileError() {
  console.error(`
${chalk.red.bold("**ERROR**")} ${chalk.red(
    `The --use-yarn option was specified but there is no yarn.lock file`,
  )}
`)
}
*/
function printNoLockfilesError() {
    console.error(`
${chalk_1.default.red.bold("**ERROR**")} ${chalk_1.default.red(`No package-lock.json, npm-shrinkwrap.json, or yarn.lock file.

You must use either npm@>=5, yarn, or npm-shrinkwrap to manage this project's
dependencies.`)}
`);
}
/*
function printSelectingDefaultMessage() {
  console.info(
    `${chalk.bold(
      "patch-package",
    )}: you have both yarn.lock and package-lock.json
Defaulting to using ${chalk.bold("npm")}
You can override this setting by passing --use-yarn or deleting
package-lock.json if you don't need it
`,
  )
}
*/
/*
function isFileInPnpmRoot(rootPath: string, filename: string): boolean {
  const osRoot = path.parse(rootPath).root

  let currentDir = rootPath

  while (currentDir !== osRoot) {
    if (fs.existsSync(path.join(currentDir, "pnpm-workspace.yaml"))) {
      // Found workspace root. If the sought file is in the workspace root,
      // we're good.
      if (fs.existsSync(path.join(currentDir, filename))) {
        return true
      } else {
        return false
      }
    } else {
      currentDir = path.resolve(currentDir, "..")
    }
  }

  return false
}
*/
function pickManager(managersFound) {
    if (managersFound.includes("yarn"))
        return "yarn";
    if (managersFound.includes("pnpm"))
        return "pnpm";
    if (managersFound.includes("npm"))
        return "npm";
    return null;
}
const detectPackageManager = (appRootPath, overridePackageManager) => {
    if (isDebug) {
        console.log(`patch-package/detectPackageManager:`);
        console.dir({
            appRootPath,
            overridePackageManager,
        });
    }
    const managerOfLockName = {
        'package-lock.json': 'npm',
        'npm-shrinkwrap.json': 'npm',
        'yarn.lock': 'yarn',
        'pnpm-lock.yaml': 'pnpm',
        'shrinkwrap.yaml': 'pnpm',
    };
    const pathParts = appRootPath.split("/");
    for (let depth = pathParts.length; depth > 0; depth--) {
        const workspaceCandidate = pathParts.slice(0, depth).join("/");
        if (isDebug) {
            console.log(`detectPackageManager: workspaceCandidate: ${workspaceCandidate}`);
        }
        // TODO fast path
        //if (overridePackageManager) {
        //  ...
        //}
        const lockfilesFound = ([
            // TODO async
            ['package-lock.json', fs_extra_1.default.existsSync((0, path_1.join)(workspaceCandidate, "package-lock.json"))],
            ['npm-shrinkwrap.json', fs_extra_1.default.existsSync((0, path_1.join)(workspaceCandidate, "npm-shrinkwrap.json"))],
            ['yarn.lock', fs_extra_1.default.existsSync((0, path_1.join)(workspaceCandidate, "yarn.lock"))],
            ['pnpm-lock.yaml', fs_extra_1.default.existsSync((0, path_1.join)(workspaceCandidate, "pnpm-lock.yaml"))],
            ['shrinkwrap.yaml', fs_extra_1.default.existsSync((0, path_1.join)(workspaceCandidate, "shrinkwrap.yaml"))], // rare
        ]
            .filter(([_file, exists]) => exists)
            .map(([file, _exists]) => file));
        if (isDebug) {
            console.log(`detectPackageManager: lockfilesFound: ${lockfilesFound.join(' ')}`);
        }
        if (lockfilesFound.length == 0) {
            continue;
        }
        if (lockfilesFound.length == 1) {
            return managerOfLockName[lockfilesFound[0]];
        }
        // found multiple lockfiles
        const managersFound = lockfilesFound.map(file => managerOfLockName[file]);
        if (overridePackageManager) {
            // TODO better. if overridePackageManager is set, we can skip some fs.existsSync calls
            if (managersFound.includes(overridePackageManager)) {
                return overridePackageManager;
            }
            continue;
        }
        const manager = pickManager(managersFound);
        if (manager)
            return manager;
        // continue to parent folder
    }
    printNoLockfilesError();
    process_1.default.exit(1);
    /*
    const packageLockExists = fs.existsSync(
      join(appRootPath, "package-lock.json"), // npm
    )
    const shrinkWrapExists = fs.existsSync(
      join(appRootPath, "npm-shrinkwrap.json"), // old npm
    )
    const yarnLockExists = fs.existsSync(join(appRootPath, "yarn.lock"))
    const pnpmLockExists = fs.existsSync(
      join(appRootPath, "pnpm-lock.yaml"),
    )
    const oldPnpmLockExists = fs.existsSync(
      join(appRootPath, "shrinkwrap.yaml"), // old pnpm. lockfileVersion < 5
    )
    if (isDebug) {
      console.dir({
        packageLockExists,
        shrinkWrapExists,
        yarnLockExists,
        pnpmLockExists,
        oldPnpmLockExists,
      })
    }
    if ((packageLockExists || shrinkWrapExists) && yarnLockExists) {
      if (overridePackageManager) {
        return overridePackageManager
      } else {
        printSelectingDefaultMessage()
        return shrinkWrapExists ? "npm-shrinkwrap" : "npm"
      }
    } else if (packageLockExists || shrinkWrapExists) {
      if (overridePackageManager === "yarn") {
        printNoYarnLockfileError()
        process.exit(1)
      } else {
        return shrinkWrapExists ? "npm-shrinkwrap" : "npm"
      }
    } else if (yarnLockExists || findYarnWorkspaceRoot()) {
      return "yarn"
    } else if (isFileInPnpmRoot(appRootPath, "pnpm-lock.yaml")) {
      // (fs.existsSync(join(appRootPath, "pnpm-lock.yaml"))) {
      return "pnpm"
    } else {
      printNoLockfilesError()
      process.exit(1)
    }
    throw Error()
    */
};
exports.detectPackageManager = detectPackageManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0ZWN0UGFja2FnZU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGV0ZWN0UGFja2FnZU1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0RBQXlCO0FBQ3pCLGlDQUE2QjtBQUM3Qix5QkFBeUI7QUFDekIsa0RBQXlCO0FBQ3pCLHNEQUE2QjtBQUs3QixnREFBZ0Q7QUFDaEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFBO0FBRTFDOzs7Ozs7OztFQVFFO0FBRUYsU0FBUyxxQkFBcUI7SUFDNUIsT0FBTyxDQUFDLEtBQUssQ0FBQztFQUNkLGVBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLGVBQUssQ0FBQyxHQUFHLENBQ3RDOzs7Y0FHVSxDQUNYO0NBQ0YsQ0FBQyxDQUFBO0FBQ0YsQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7RUFZRTtBQUVGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0VBc0JFO0FBRUYsU0FBUyxXQUFXLENBQUMsYUFBYTtJQUNoQyxJQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1FBQUUsT0FBTyxNQUFNLENBQUE7SUFDakQsSUFBSSxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztRQUFFLE9BQU8sTUFBTSxDQUFBO0lBQ2pELElBQUksYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQTtJQUMvQyxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUFFTSxNQUFNLG9CQUFvQixHQUFHLENBQ2xDLFdBQW1CLEVBQ25CLHNCQUE2QyxFQUM3QixFQUFFO0lBQ2xCLElBQUksT0FBTyxFQUFFO1FBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFBO1FBQ2xELE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDVixXQUFXO1lBQ1gsc0JBQXNCO1NBQ3ZCLENBQUMsQ0FB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Q0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O01BK0NFO0FBQ0osQ0FBQyxDQUFBO0FBbEhZLFFBQUEsb0JBQW9CLHdCQWtIaEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSBcImZzLWV4dHJhXCJcbmltcG9ydCB7IGpvaW4gfSBmcm9tIFwiLi9wYXRoXCJcbi8vaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIlxuaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiXG5pbXBvcnQgcHJvY2VzcyBmcm9tIFwicHJvY2Vzc1wiXG4vL2ltcG9ydCBmaW5kWWFybldvcmtzcGFjZVJvb3QgZnJvbSBcImZpbmQteWFybi13b3Jrc3BhY2Utcm9vdFwiXG5cbmV4cG9ydCB0eXBlIFBhY2thZ2VNYW5hZ2VyID0gXCJ5YXJuXCIgfCBcIm5wbVwiIHwgXCJucG0tc2hyaW5rd3JhcFwiIHwgXCJwbnBtXCJcblxuLy9jb25zdCBpc1ZlcmJvc2UgPSBnbG9iYWwucGF0Y2hQYWNrYWdlSXNWZXJib3NlXG5jb25zdCBpc0RlYnVnID0gZ2xvYmFsLnBhdGNoUGFja2FnZUlzRGVidWdcblxuLypcbmZ1bmN0aW9uIHByaW50Tm9ZYXJuTG9ja2ZpbGVFcnJvcigpIHtcbiAgY29uc29sZS5lcnJvcihgXG4ke2NoYWxrLnJlZC5ib2xkKFwiKipFUlJPUioqXCIpfSAke2NoYWxrLnJlZChcbiAgICBgVGhlIC0tdXNlLXlhcm4gb3B0aW9uIHdhcyBzcGVjaWZpZWQgYnV0IHRoZXJlIGlzIG5vIHlhcm4ubG9jayBmaWxlYCxcbiAgKX1cbmApXG59XG4qL1xuXG5mdW5jdGlvbiBwcmludE5vTG9ja2ZpbGVzRXJyb3IoKSB7XG4gIGNvbnNvbGUuZXJyb3IoYFxuJHtjaGFsay5yZWQuYm9sZChcIioqRVJST1IqKlwiKX0gJHtjaGFsay5yZWQoXG4gICAgYE5vIHBhY2thZ2UtbG9jay5qc29uLCBucG0tc2hyaW5rd3JhcC5qc29uLCBvciB5YXJuLmxvY2sgZmlsZS5cblxuWW91IG11c3QgdXNlIGVpdGhlciBucG1APj01LCB5YXJuLCBvciBucG0tc2hyaW5rd3JhcCB0byBtYW5hZ2UgdGhpcyBwcm9qZWN0J3NcbmRlcGVuZGVuY2llcy5gLFxuICApfVxuYClcbn1cblxuLypcbmZ1bmN0aW9uIHByaW50U2VsZWN0aW5nRGVmYXVsdE1lc3NhZ2UoKSB7XG4gIGNvbnNvbGUuaW5mbyhcbiAgICBgJHtjaGFsay5ib2xkKFxuICAgICAgXCJwYXRjaC1wYWNrYWdlXCIsXG4gICAgKX06IHlvdSBoYXZlIGJvdGggeWFybi5sb2NrIGFuZCBwYWNrYWdlLWxvY2suanNvblxuRGVmYXVsdGluZyB0byB1c2luZyAke2NoYWxrLmJvbGQoXCJucG1cIil9XG5Zb3UgY2FuIG92ZXJyaWRlIHRoaXMgc2V0dGluZyBieSBwYXNzaW5nIC0tdXNlLXlhcm4gb3IgZGVsZXRpbmdcbnBhY2thZ2UtbG9jay5qc29uIGlmIHlvdSBkb24ndCBuZWVkIGl0XG5gLFxuICApXG59XG4qL1xuXG4vKlxuZnVuY3Rpb24gaXNGaWxlSW5QbnBtUm9vdChyb290UGF0aDogc3RyaW5nLCBmaWxlbmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gIGNvbnN0IG9zUm9vdCA9IHBhdGgucGFyc2Uocm9vdFBhdGgpLnJvb3RcblxuICBsZXQgY3VycmVudERpciA9IHJvb3RQYXRoXG5cbiAgd2hpbGUgKGN1cnJlbnREaXIgIT09IG9zUm9vdCkge1xuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihjdXJyZW50RGlyLCBcInBucG0td29ya3NwYWNlLnlhbWxcIikpKSB7XG4gICAgICAvLyBGb3VuZCB3b3Jrc3BhY2Ugcm9vdC4gSWYgdGhlIHNvdWdodCBmaWxlIGlzIGluIHRoZSB3b3Jrc3BhY2Ugcm9vdCxcbiAgICAgIC8vIHdlJ3JlIGdvb2QuXG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oY3VycmVudERpciwgZmlsZW5hbWUpKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJlbnREaXIgPSBwYXRoLnJlc29sdmUoY3VycmVudERpciwgXCIuLlwiKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWxzZVxufVxuKi9cblxuZnVuY3Rpb24gcGlja01hbmFnZXIobWFuYWdlcnNGb3VuZCkge1xuICBpZiAobWFuYWdlcnNGb3VuZC5pbmNsdWRlcyhcInlhcm5cIikpIHJldHVybiBcInlhcm5cIlxuICBpZiAobWFuYWdlcnNGb3VuZC5pbmNsdWRlcyhcInBucG1cIikpIHJldHVybiBcInBucG1cIlxuICBpZiAobWFuYWdlcnNGb3VuZC5pbmNsdWRlcyhcIm5wbVwiKSkgcmV0dXJuIFwibnBtXCJcbiAgcmV0dXJuIG51bGxcbn1cblxuZXhwb3J0IGNvbnN0IGRldGVjdFBhY2thZ2VNYW5hZ2VyID0gKFxuICBhcHBSb290UGF0aDogc3RyaW5nLFxuICBvdmVycmlkZVBhY2thZ2VNYW5hZ2VyOiBQYWNrYWdlTWFuYWdlciB8IG51bGwsXG4pOiBQYWNrYWdlTWFuYWdlciA9PiB7XG4gIGlmIChpc0RlYnVnKSB7XG4gICAgY29uc29sZS5sb2coYHBhdGNoLXBhY2thZ2UvZGV0ZWN0UGFja2FnZU1hbmFnZXI6YClcbiAgICBjb25zb2xlLmRpcih7XG4gICAgICBhcHBSb290UGF0aCxcbiAgICAgIG92ZXJyaWRlUGFja2FnZU1hbmFnZXIsXG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IG1hbmFnZXJPZkxvY2tOYW1lID0ge1xuICAgICdwYWNrYWdlLWxvY2suanNvbic6ICducG0nLFxuICAgICducG0tc2hyaW5rd3JhcC5qc29uJzogJ25wbScsXG4gICAgJ3lhcm4ubG9jayc6ICd5YXJuJyxcbiAgICAncG5wbS1sb2NrLnlhbWwnOiAncG5wbScsXG4gICAgJ3Nocmlua3dyYXAueWFtbCc6ICdwbnBtJyxcbiAgfVxuXG4gIGNvbnN0IHBhdGhQYXJ0cyA9IGFwcFJvb3RQYXRoLnNwbGl0KFwiL1wiKVxuICBmb3IgKGxldCBkZXB0aCA9IHBhdGhQYXJ0cy5sZW5ndGg7IGRlcHRoID4gMDsgZGVwdGgtLSkge1xuICAgICAgY29uc3Qgd29ya3NwYWNlQ2FuZGlkYXRlID0gcGF0aFBhcnRzLnNsaWNlKDAsIGRlcHRoKS5qb2luKFwiL1wiKVxuICAgICAgaWYgKGlzRGVidWcpIHtcbiAgICAgICAgY29uc29sZS5sb2coYGRldGVjdFBhY2thZ2VNYW5hZ2VyOiB3b3Jrc3BhY2VDYW5kaWRhdGU6ICR7d29ya3NwYWNlQ2FuZGlkYXRlfWApXG4gICAgICB9XG4gICAgICAvLyBUT0RPIGZhc3QgcGF0aFxuICAgICAgLy9pZiAob3ZlcnJpZGVQYWNrYWdlTWFuYWdlcikge1xuICAgICAgLy8gIC4uLlxuICAgICAgLy99XG4gICAgICBjb25zdCBsb2NrZmlsZXNGb3VuZDogc3RyaW5nW10gPSAoXG4gICAgICAgIChbXG4gICAgICAgICAgLy8gVE9ETyBhc3luY1xuICAgICAgICAgIFsncGFja2FnZS1sb2NrLmpzb24nLCBmcy5leGlzdHNTeW5jKGpvaW4od29ya3NwYWNlQ2FuZGlkYXRlLCBcInBhY2thZ2UtbG9jay5qc29uXCIpKV0sXG4gICAgICAgICAgWyducG0tc2hyaW5rd3JhcC5qc29uJywgZnMuZXhpc3RzU3luYyhqb2luKHdvcmtzcGFjZUNhbmRpZGF0ZSwgXCJucG0tc2hyaW5rd3JhcC5qc29uXCIpKV0sIC8vIHJhcmVcbiAgICAgICAgICBbJ3lhcm4ubG9jaycsIGZzLmV4aXN0c1N5bmMoam9pbih3b3Jrc3BhY2VDYW5kaWRhdGUsIFwieWFybi5sb2NrXCIpKV0sXG4gICAgICAgICAgWydwbnBtLWxvY2sueWFtbCcsIGZzLmV4aXN0c1N5bmMoam9pbih3b3Jrc3BhY2VDYW5kaWRhdGUsIFwicG5wbS1sb2NrLnlhbWxcIikpXSxcbiAgICAgICAgICBbJ3Nocmlua3dyYXAueWFtbCcsIGZzLmV4aXN0c1N5bmMoam9pbih3b3Jrc3BhY2VDYW5kaWRhdGUsIFwic2hyaW5rd3JhcC55YW1sXCIpKV0sIC8vIHJhcmVcbiAgICAgICAgXSBhcyBBcnJheTxbc3RyaW5nLCBib29sZWFuXT4pXG4gICAgICAgIC5maWx0ZXIoKFtfZmlsZSwgZXhpc3RzXSkgPT4gZXhpc3RzKVxuICAgICAgICAubWFwKChbZmlsZSwgX2V4aXN0c10pID0+IGZpbGUpXG4gICAgICApXG4gICAgICBpZiAoaXNEZWJ1Zykge1xuICAgICAgICBjb25zb2xlLmxvZyhgZGV0ZWN0UGFja2FnZU1hbmFnZXI6IGxvY2tmaWxlc0ZvdW5kOiAke2xvY2tmaWxlc0ZvdW5kLmpvaW4oJyAnKX1gKVxuICAgICAgfVxuICAgICAgaWYgKGxvY2tmaWxlc0ZvdW5kLmxlbmd0aCA9PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG4gICAgICBpZiAobG9ja2ZpbGVzRm91bmQubGVuZ3RoID09IDEpIHtcbiAgICAgICAgcmV0dXJuIG1hbmFnZXJPZkxvY2tOYW1lW2xvY2tmaWxlc0ZvdW5kWzBdXVxuICAgICAgfVxuICAgICAgLy8gZm91bmQgbXVsdGlwbGUgbG9ja2ZpbGVzXG4gICAgICBjb25zdCBtYW5hZ2Vyc0ZvdW5kID0gbG9ja2ZpbGVzRm91bmQubWFwKGZpbGUgPT4gbWFuYWdlck9mTG9ja05hbWVbZmlsZV0pXG4gICAgICBpZiAob3ZlcnJpZGVQYWNrYWdlTWFuYWdlcikge1xuICAgICAgICAvLyBUT0RPIGJldHRlci4gaWYgb3ZlcnJpZGVQYWNrYWdlTWFuYWdlciBpcyBzZXQsIHdlIGNhbiBza2lwIHNvbWUgZnMuZXhpc3RzU3luYyBjYWxsc1xuICAgICAgICBpZiAobWFuYWdlcnNGb3VuZC5pbmNsdWRlcyhvdmVycmlkZVBhY2thZ2VNYW5hZ2VyKSkge1xuICAgICAgICAgIHJldHVybiBvdmVycmlkZVBhY2thZ2VNYW5hZ2VyXG4gICAgICAgIH1cbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1hbmFnZXIgPSBwaWNrTWFuYWdlcihtYW5hZ2Vyc0ZvdW5kKVxuICAgICAgaWYgKG1hbmFnZXIpIHJldHVybiBtYW5hZ2VyXG4gICAgICAvLyBjb250aW51ZSB0byBwYXJlbnQgZm9sZGVyXG4gIH1cbiAgcHJpbnROb0xvY2tmaWxlc0Vycm9yKCk7XG4gIHByb2Nlc3MuZXhpdCgxKTtcbiAgLypcbiAgY29uc3QgcGFja2FnZUxvY2tFeGlzdHMgPSBmcy5leGlzdHNTeW5jKFxuICAgIGpvaW4oYXBwUm9vdFBhdGgsIFwicGFja2FnZS1sb2NrLmpzb25cIiksIC8vIG5wbVxuICApXG4gIGNvbnN0IHNocmlua1dyYXBFeGlzdHMgPSBmcy5leGlzdHNTeW5jKFxuICAgIGpvaW4oYXBwUm9vdFBhdGgsIFwibnBtLXNocmlua3dyYXAuanNvblwiKSwgLy8gb2xkIG5wbVxuICApXG4gIGNvbnN0IHlhcm5Mb2NrRXhpc3RzID0gZnMuZXhpc3RzU3luYyhqb2luKGFwcFJvb3RQYXRoLCBcInlhcm4ubG9ja1wiKSlcbiAgY29uc3QgcG5wbUxvY2tFeGlzdHMgPSBmcy5leGlzdHNTeW5jKFxuICAgIGpvaW4oYXBwUm9vdFBhdGgsIFwicG5wbS1sb2NrLnlhbWxcIiksXG4gIClcbiAgY29uc3Qgb2xkUG5wbUxvY2tFeGlzdHMgPSBmcy5leGlzdHNTeW5jKFxuICAgIGpvaW4oYXBwUm9vdFBhdGgsIFwic2hyaW5rd3JhcC55YW1sXCIpLCAvLyBvbGQgcG5wbS4gbG9ja2ZpbGVWZXJzaW9uIDwgNVxuICApXG4gIGlmIChpc0RlYnVnKSB7XG4gICAgY29uc29sZS5kaXIoe1xuICAgICAgcGFja2FnZUxvY2tFeGlzdHMsXG4gICAgICBzaHJpbmtXcmFwRXhpc3RzLFxuICAgICAgeWFybkxvY2tFeGlzdHMsXG4gICAgICBwbnBtTG9ja0V4aXN0cyxcbiAgICAgIG9sZFBucG1Mb2NrRXhpc3RzLFxuICAgIH0pXG4gIH1cbiAgaWYgKChwYWNrYWdlTG9ja0V4aXN0cyB8fCBzaHJpbmtXcmFwRXhpc3RzKSAmJiB5YXJuTG9ja0V4aXN0cykge1xuICAgIGlmIChvdmVycmlkZVBhY2thZ2VNYW5hZ2VyKSB7XG4gICAgICByZXR1cm4gb3ZlcnJpZGVQYWNrYWdlTWFuYWdlclxuICAgIH0gZWxzZSB7XG4gICAgICBwcmludFNlbGVjdGluZ0RlZmF1bHRNZXNzYWdlKClcbiAgICAgIHJldHVybiBzaHJpbmtXcmFwRXhpc3RzID8gXCJucG0tc2hyaW5rd3JhcFwiIDogXCJucG1cIlxuICAgIH1cbiAgfSBlbHNlIGlmIChwYWNrYWdlTG9ja0V4aXN0cyB8fCBzaHJpbmtXcmFwRXhpc3RzKSB7XG4gICAgaWYgKG92ZXJyaWRlUGFja2FnZU1hbmFnZXIgPT09IFwieWFyblwiKSB7XG4gICAgICBwcmludE5vWWFybkxvY2tmaWxlRXJyb3IoKVxuICAgICAgcHJvY2Vzcy5leGl0KDEpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzaHJpbmtXcmFwRXhpc3RzID8gXCJucG0tc2hyaW5rd3JhcFwiIDogXCJucG1cIlxuICAgIH1cbiAgfSBlbHNlIGlmICh5YXJuTG9ja0V4aXN0cyB8fCBmaW5kWWFybldvcmtzcGFjZVJvb3QoKSkge1xuICAgIHJldHVybiBcInlhcm5cIlxuICB9IGVsc2UgaWYgKGlzRmlsZUluUG5wbVJvb3QoYXBwUm9vdFBhdGgsIFwicG5wbS1sb2NrLnlhbWxcIikpIHtcbiAgICAvLyAoZnMuZXhpc3RzU3luYyhqb2luKGFwcFJvb3RQYXRoLCBcInBucG0tbG9jay55YW1sXCIpKSkge1xuICAgIHJldHVybiBcInBucG1cIlxuICB9IGVsc2Uge1xuICAgIHByaW50Tm9Mb2NrZmlsZXNFcnJvcigpXG4gICAgcHJvY2Vzcy5leGl0KDEpXG4gIH1cbiAgdGhyb3cgRXJyb3IoKVxuICAqL1xufVxuIl19